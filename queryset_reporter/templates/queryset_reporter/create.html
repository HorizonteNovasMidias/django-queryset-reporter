{% extends "queryset_reporter/base.html" %}

{% load i18n %}

{% block extra-js %}
{% endblock %}

{% block content %}

{% if rendered_csv %}
<div class="alert alert-success">
  <button type="button" class="close" data-dismiss="alert">&times;</button>
  <h4>{% trans "CSV gerado" %}</h4>
  {% trans "Acesse-o através desta URL: " %}<a href="{{ rendered_csv }}">{{ rendered_csv }}</a>
</div>
{% endif %}

{% if rendered_xlsx %}
<div class="alert alert-success">
  <button type="button" class="close" data-dismiss="alert">&times;</button>
  <h4>{% trans "XLSX gerado" %}</h4>
  {% trans "Acesse-o através desta URL: " %}<a href="{{ rendered_xlsx }}">{{ rendered_xlsx }}</a>
</div>
{% endif %}

<form action="{% url qsr_create %}" method="GET" id="querysets-form">
{% if queryset %}
<input type="hidden" value="{{ queryset.id }}" name="queryset" /> 
{% endif %}
<div class="row-fluid">
    {% if queryset %}    
    <div class="span3">
        <ul class="nav filter-nav">

            <li class="nav-header">{% trans "Filtros" %}<li>
            {% for filter in reporter.get_filters %}
            {% include 'queryset_reporter/filter_fields.html' %}
            {% endfor %}
            
            <li class="nav-header">{% trans "Exclusões" %}<li>
            {% for filter in reporter.get_excludes %}
            {% include 'queryset_reporter/filter_fields.html' %}
            {% endfor %}

        </ul>
    </div>
    {% endif %}

    <div class="span9">
            <fieldset>
                <legend>
                    {% if queryset %}
                        {{ queryset }}
                    {% else %}
                        {% trans "Criar Relatório" %}
                    {% endif %}
                </legend>
                {% if queryset%}
                <div class="btn-toolbar">
                    <button class="btn btn-primary" type="submit">
                        <i class="icon-refresh"></i>
                        {% trans "Aplicar filtros" %}</button>
                    <div class="btn-group">
                        <button class="btn dropdown-toggle" data-toggle="dropdown">{% trans "Ação" %} <span class="caret"></span></button>
                        <ul class="dropdown-menu">
                            <li><a href="{% url qsr_create %}?queryset={{ queryset.pk }}">{% trans "Zerar filtros" %}</a></li>
                        <li><a href="{% url qsr_create %}">{% trans "Selecionar outro modelo" %}</a></li>
                        </ul>
                    </div><!-- /btn-group -->
                    <div class="btn-group">
                        <button class="btn btn-success dropdown-toggle" data-toggle="dropdown">{% trans "Gerar relatório" %}<span class="caret"></span></button>
                        <ul class="dropdown-menu">
                            <li><a href="?{{ request.META.QUERY_STRING }}&format=csv">CSV</a></li>
                            <li><a href="?{{ request.META.QUERY_STRING }}&format=xlsx">XLSX</a></li>
                        {% comment %}
                        <li><a href="#">CSV</a></li>
                        <li><a href="#">PDF</a></li>
                        <li><a href="#">HTML</a></li>
                        {% endcomment %}
                        </ul>
                    </div><!-- /btn-group -->
                </div><!-- /btn-toolbar -->
                {% else %}
                <select class="input-xxlarge" name="queryset">
                    <option value="">{% trans "Selecione o modelo" %}</option>
                    {% for qs in querysets %}
                    <option value="{{ qs.pk }}"
                        {% if qs.pk == queryset.pk %} selected="selected"{% endif %}>
                        {{ qs }}
                    </option>
                    {% endfor %}
                </select>
                {% endif %}
            </fieldset>
        </form>

        {% if reporter %}
        <dl>
            <dt>{% trans "Total de resultados" %}</dt>
            <dd>{{ reporter.count }}</dd>
            <dt>{% trans "Pré-visualização" %}</dt>
            <dd>{{ reporter.preview.count }}</dd>
        </dl>
        {% endif %}

        {% with reporter.preview as preview %}
        {% if preview %}
        <table class="table table-striped table-condensed table-hover table-bordered">
            <thead>
                <tr>
                {% for field in display_fields %}
                    <th>{{ field.field_verbose|capfirst }}</th>
                {% endfor%}
                </tr>
            </thead>
            <tbody>
            {% for line in preview %}
            <tr>
                {% for item in line %}
                <td>{{ item }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% endif %}
        {% endwith %}
    </div>

</div>
</form>
{% endblock %}
